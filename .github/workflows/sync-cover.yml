
name: Sync Cover from Website (R2)

on:
  push:
    paths:
      - 'manga.json'
      - 'manga-config.json'
  repository_dispatch:
    types: [sync-covers]
  workflow_dispatch:


permissions:
  contents: write

jobs:
  sync-cover:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”§ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ðŸ“¥ Sync Cover URL from R2
        run: |
          echo "[INFO] Fetching latest cover info from website..."
          
          # Get repo name from GitHub context
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          echo "[REPO] Current repo: $REPO_NAME"
          
          # Fetch manga-config.js from main website repo
          WEBSITE_CONFIG_URL="https://raw.githubusercontent.com/nurananto/nuranantoscans/main/manga-config.js"
          
          echo "[FETCH] Downloading manga-config.js..."
          
          # Retry mechanism: GitHub might need a few seconds to process commit
          MAX_RETRIES=5
          RETRY_DELAY=3
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "[FETCH] Attempt $i/$MAX_RETRIES..."
            curl -s "$WEBSITE_CONFIG_URL" -o /tmp/website-config.js
            
            if [ -f /tmp/website-config.js ] && [ -s /tmp/website-config.js ]; then
              echo "[SUCCESS] manga-config.js downloaded successfully"
              break
            else
              if [ $i -lt $MAX_RETRIES ]; then
                echo "[RETRY] File not available yet, waiting ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              else
                echo "[FAILED] Failed to download manga-config.js after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          # Extract R2 cover URL for this repo
          echo "[EXTRACT] Extracting cover URL for $REPO_NAME..."
          COVER_URL=$(node -e "
            const fs = require('fs');
            const content = fs.readFileSync('/tmp/website-config.js', 'utf-8');
            const vm = require('vm');
            const sandbox = { MANGA_LIST: null, MANGA_REPOS: null };
            vm.createContext(sandbox);
            
            try {
              vm.runInContext(content, sandbox);
              
              if (!sandbox.MANGA_LIST) {
                console.error('[FAILED] MANGA_LIST not found');
                process.exit(1);
              }
              
              const manga = sandbox.MANGA_LIST.find(m => m.repo === '${REPO_NAME}');
              
              if (manga && manga.cover) {
                console.log(manga.cover);
              } else {
                console.error('[FAILED] Cover not found for repo: ${REPO_NAME}');
                process.exit(1);
              }
            } catch (error) {
              console.error('[FAILED] Parse config:', error.message);
              process.exit(1);
            }
          ")
          
          if [ -z "$COVER_URL" ]; then
            echo "[WARN] No cover URL found for this repo"
            exit 0
          fi
          
          echo "[SUCCESS] Found cover URL: $COVER_URL"
          
          # Validate it's an R2 URL
          if [[ "$COVER_URL" == *"r2.cloudflarestorage.com"* ]] || [[ "$COVER_URL" == *".r2.dev"* ]] || [[ "$COVER_URL" == *"cdn.nuranantoscans.my.id"* ]]; then
            echo "[VALID] R2 URL detected"
          else
            echo "[WARN] URL is not from R2, but will proceed"
          fi
          
          # Update manga-config.json
          if [ -f manga-config.json ]; then
            echo "[UPDATE] Updating manga-config.json..."
            
            # Backup original
            cp manga-config.json manga-config.json.backup
            
            node -e "
              const fs = require('fs');
              
              try {
                const config = JSON.parse(fs.readFileSync('manga-config.json', 'utf-8'));
                const oldCover = config.cover;
                config.cover = '${COVER_URL}';
                
                fs.writeFileSync('manga-config.json', JSON.stringify(config, null, 2));
                
                if (oldCover !== config.cover) {
                  console.log('[SUCCESS] manga-config.json cover URL updated');
                  console.log('  Old:', oldCover);
                  console.log('  New:', config.cover);
                } else {
                  console.log('[INFO] manga-config.json cover URL unchanged');
                }
              } catch (error) {
                console.error('[FAILED] Updating manga-config.json:', error.message);
                process.exit(1);
              }
            "
          else
            echo "[WARN] manga-config.json not found in this repo"
          fi
          
          # Update manga.json (inside manga object)
          if [ -f manga.json ]; then
            echo "[UPDATE] Updating manga.json..."
            
            # Backup original
            cp manga.json manga.json.backup
            
            node -e "
              const fs = require('fs');
              
              try {
                const data = JSON.parse(fs.readFileSync('manga.json', 'utf-8'));
                
                if (data.manga) {
                  const oldCover = data.manga.cover;
                  data.manga.cover = '${COVER_URL}';
                  
                  fs.writeFileSync('manga.json', JSON.stringify(data, null, 2));
                  
                  if (oldCover !== data.manga.cover) {
                    console.log('[SUCCESS] manga.json cover URL updated');
                    console.log('  Old:', oldCover);
                    console.log('  New:', data.manga.cover);
                  } else {
                    console.log('[INFO] manga.json cover URL unchanged');
                  }
                } else {
                  console.log('[WARN] manga.json does not have manga object');
                }
              } catch (error) {
                console.error('[FAILED] Updating manga.json:', error.message);
                process.exit(1);
              }
            "
          else
            echo "[WARN] manga.json not found in this repo"
          fi
      
      - name: ðŸ” Check for Changes
        id: check_changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "[SUCCESS] Changes detected"
            git status -s
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "[INFO] No changes detected"
          fi
      
      - name: ðŸ’¾ Commit and Push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add manga-config.json manga.json
          
          # âœ… [skip ci] prevents manga-automation.yml from triggering
          COMMIT_MSG="ðŸ¤– Auto-sync cover from R2 - $(date +'%Y-%m-%d %H:%M') [skip ci]"
          git commit -m "$COMMIT_MSG"
          
          git push
          
          echo ""
          echo "[COMPLETE] Cover synced successfully!"
          echo "[INFO] manga-automation.yml SKIPPED (cover-only update)"
      
      - name: âœ… Complete
        run: |
          if [[ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]]; then
            echo "[SUCCESS] Cover URL updated successfully"
            echo "[INFO] New cover is now hosted on Cloudflare R2"
            echo "      - manga-config.json: Updated"
            echo "      - manga.json: Updated"
            echo "      - Website trigger: SKIPPED (cover already in website)"
          else
            echo "[INFO] Cover URL unchanged (already up-to-date)"
            echo "[INFO] No action needed"
          fi
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f /tmp/website-config.js manga-config.json.backup manga.json.backup
